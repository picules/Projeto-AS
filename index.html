<!-- ...head e CSS iguais ao que te enviei... -->

<body>
  <div class="container">
    <h2>Sistema de Controle de Dívidas</h2>

    <div id="login-section">
      <!-- ...igual... -->
    </div>

    <div id="logado-msg" style="display:none;">
      <span></span>
      <button id="btn-sair" onclick="sair()">Sair</button>
    </div>

    <!-- NOVO: barra do ADM (aparece só para Vagner) -->
    <div id="adm-bar" style="display:none; margin:10px 0 15px 0;">
      <a id="apk-link" href="#" download
         style="background:#222;color:#fff;padding:10px 14px;border-radius:8px;text-decoration:none;">
        <i class="fa-solid fa-download"></i> Baixar App (ADM)
      </a>
    </div>

    <div id="formulario" style="display:none;">
      <!-- ...igual... -->
    </div>

    <div class="info-regras">
      <!-- ...igual... -->
    </div>

    <div id="lista" style="margin-top:20px;"></div>
  </div>

  <a href="https://wa.me/5583996323995" target="_blank" rel="noopener noreferrer" class="whatsapp-btn" aria-label="WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // --- CONFIGS EDITÁVEIS ---
    // NOVO: URL pública da Cloud Function que envia a mensagem no WhatsApp
    const NOTIFY_URL = "https://REGIAO-PROJETO.cloudfunctions.net/notifyPago"; // <-- troque depois
    // NOVO: link do APK que só o ADM verá
    const APK_URL = "https://seu-dominio.com/cdv-adm.apk"; // <-- troque para o link real

    // Firebase (igual)
    const firebaseConfig = { /* ...seu config igual ao anterior... */ 
      apiKey: "AIzaSyCfHDdYAW8DkZ-XELvUWhUo3ln5rAu-1h8",
      authDomain: "adrjb-99601.firebaseapp.com",
      projectId: "adrjb-99601",
      storageBucket: "adrjb-99601.firebasestorage.app",
      messagingSenderId: "688129341856",
      appId: "1:688129341856:web:c0a378171329e52c038cc5",
      measurementId: "G-2BXZJ9LETC",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const senhas = { Karol:"14", Rodrigo:"@4", Gabriela:"66", Vagner:"admin" };

    let devedores = [];
    let usuarioAtual = "";

    // DOM
    const loginSection = document.getElementById("login-section");
    const logadoMsg = document.getElementById("logado-msg");
    const formulario = document.getElementById("formulario");
    const lista = document.getElementById("lista");
    const funcionarioSelect = document.getElementById("funcionario");
    const senhaInput = document.getElementById("senha");
    const lembrarSenhaCheckbox = document.getElementById("lembrarSenha");
    const nomeClienteInput = document.getElementById("nomeCliente");
    const valorInput = document.getElementById("valor");
    const btnEntrar = document.getElementById("btn-entrar");
    const btnAdd = document.getElementById("btn-add");
    // NOVO:
    const admBar = document.getElementById("adm-bar");
    const apkLink = document.getElementById("apk-link");

    funcionarioSelect.addEventListener("change", () => {
      const sel = funcionarioSelect.value;
      senhaInput.value = localStorage.getItem(`senha_${sel}`) || "";
    });

    senhaInput.addEventListener("keydown", (e) => { if (e.key === "Enter") btnEntrar.click(); });
    nomeClienteInput.addEventListener("keydown", (e) => { if (e.key === "Enter") btnAdd.click(); });
    valorInput.addEventListener("keydown", (e) => { if (e.key === "Enter") btnAdd.click(); });

    window.addEventListener("DOMContentLoaded", () => { funcionarioSelect.focus(); });

    function mostrarLogin(m){ loginSection.style.display = m ? "block" : "none"; }
    function mostrarLogadoMsg(m){
      if(m){ logadoMsg.querySelector("span").textContent = `Logado como ${usuarioAtual}`; logadoMsg.style.display="flex";}
      else { logadoMsg.style.display="none"; }
    }
    function mostrarFormulario(m){ formulario.style.display = m ? "block" : "none"; }
    function mostrarLista(m){ lista.style.display = m ? "block" : "none"; }
    // NOVO: mostra barra do ADM
    function mostrarAdmBar(m){
      if(m){ admBar.style.display = "block"; apkLink.href = APK_URL; }
      else { admBar.style.display = "none"; }
    }

    window.acessarSistema = function () {
      const funcionario = funcionarioSelect.value;
      const senha = senhaInput.value;
      if (!funcionario || senha !== senhas[funcionario]) { alert("Senha incorreta!"); return; }
      usuarioAtual = funcionario;

      if (lembrarSenhaCheckbox.checked) localStorage.setItem(`senha_${usuarioAtual}`, senhaInput.value);
      else localStorage.removeItem(`senha_${usuarioAtual}`);

      mostrarLogin(false);
      mostrarLogadoMsg(true);
      mostrarFormulario(true);
      mostrarLista(true);
      // NOVO: só ADM enxerga o botão de APK
      mostrarAdmBar(usuarioAtual === "Vagner");

      iniciarListenerRealtime();
      nomeClienteInput.focus();
    };

    window.sair = function () {
      usuarioAtual = "";
      mostrarLogin(true);
      mostrarLogadoMsg(false);
      mostrarFormulario(false);
      mostrarLista(false);
      mostrarAdmBar(false); // NOVO
      senhaInput.value = "";
      funcionarioSelect.value = "";
      lista.innerHTML = "";
      nomeClienteInput.value = "";
      valorInput.value = "";
      funcionarioSelect.focus();
    };

    function diasDesde(iso){ if(!iso) return Infinity; return (Date.now()-new Date(iso).getTime())/(1000*60*60*24); }
    function fmtValor(v){ try{return (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}catch{return `R$ ${Number(v).toFixed(2)}`} }

    function atualizarLista(){
      const devendo=[], pagos=[], apagados=[];
      const tarefasDelete=[];
      devedores.forEach(d=>{
        if(d.removida){
          if(diasDesde(d.dataApagada)>=15 && d.id) tarefasDelete.push(deleteDoc(doc(db,"dividas",d.id)));
          else apagados.push(d);
        } else if(d.pago){
          if(diasDesde(d.dataPago)>=20 && d.id) tarefasDelete.push(deleteDoc(doc(db,"dividas",d.id)));
          else pagos.push(d);
        } else devendo.push(d);
      });
      Promise.allSettled(tarefasDelete);

      devendo.sort((a,b)=> new Date(b.dataDevendo)-new Date(a.dataDevendo));
      pagos.sort((a,b)=> new Date(b.dataPago||b.dataDevendo)-new Date(a.dataPago||a.dataDevendo));
      apagados.sort((a,b)=> new Date(b.dataApagada||b.dataDevendo)-new Date(a.dataApagada||a.dataDevendo));

      lista.innerHTML="";
      const renderDevendo=(d,i=0)=>{
        const el=document.createElement("div");
        el.className="devedor";
        el.innerHTML=`
          <strong>${d.nome}</strong> - ${fmtValor(d.valor)}
          <div class="info">Anotado por: ${d.funcionario} em ${new Date(d.dataDevendo).toLocaleString()}</div>
          <button class="btn-devendo" onclick="marcarPago(${i})">Devendo</button>
          ${(usuarioAtual===d.funcionario || usuarioAtual==="Vagner")?`<button class="btn-excluir" onclick="excluir(${i})">Excluir</button>`:""}
        `;
        lista.appendChild(el);
      };
      const renderPago=(d,i=0)=>{
        const el=document.createElement("div");
        el.className="devedor";
        el.innerHTML=`
          <strong>${d.nome}</strong> - ${fmtValor(d.valor)}
          <div class="info">Anotado por: ${d.funcionario} em ${new Date(d.dataDevendo).toLocaleString()}</div>
          <button class="btn-pago" disabled>Pago por ${d.quemPagou || "-"}<br>${d.dataPago?new Date(d.dataPago).toLocaleString():"-"}</button>
          ${(usuarioAtual===d.funcionario || usuarioAtual==="Vagner")?`<button class="btn-excluir" onclick="excluir(${i})">Excluir</button>`:""}
        `;
        lista.appendChild(el);
      };
      const renderApagado=(d)=>{
        const el=document.createElement("div");
        el.className="devedor apagada";
        el.innerHTML=`
          <strong>${d.nome}</strong> - ${fmtValor(d.valor)}<br>
          <span style="font-size:13px;color:#555;">Apagada por ${d.apagadaPorVagner?"Vagner":d.funcionario} em ${d.dataApagada?new Date(d.dataApagada).toLocaleString():"-"}</span><br>
          <em>Motivo: ${d.motivoExclusao || "Não informado"}</em>
        `;
        lista.appendChild(el);
      };

      const exibicao=[...devendo,...pagos,...apagados];
      exibicao.forEach((d,idx)=>{ if(d.removida) renderApagado(d); else if(d.pago) renderPago(d,idx); else renderDevendo(d,idx); });
      window._exibicaoAtual = exibicao;
    }

    async function iniciarListenerRealtime(){
      const q = query(collection(db,"dividas"), orderBy("dataDevendo","desc"));
      onSnapshot(q, snap=>{
        devedores = snap.docs.map(docSnap=>({ id:docSnap.id, ...docSnap.data() }));
        atualizarLista();
      });
    }

    window.adicionarDivida = async function(){
      const nome = nomeClienteInput.value.trim();
      const valor = parseFloat(valorInput.value);
      const dataHora = new Date().toISOString();
      if(!nome || isNaN(valor) || valor<=0){ alert("Preencha nome e valor corretamente!"); return; }
      if(devedores.filter(d=>!d.removida).length>=100){ alert("Limite de 100 clientes ativos atingido."); return; }

      await addDoc(collection(db,"dividas"),{
        nome, valor, funcionario:usuarioAtual, dataDevendo:dataHora,
        pago:false, quemPagou:"", dataPago:"",
        removida:false, apagadaPorVagner:false, dataApagada:"", motivoExclusao:""
      });
      nomeClienteInput.value=""; valorInput.value=""; nomeClienteInput.focus();
    };

    window.marcarPago = async function(index){
      const d = (window._exibicaoAtual||[])[index];
      if(!d || d.pago || d.removida) return;
      const docRef = doc(db,"dividas", d.id);
      const quando = new Date().toISOString();

      await updateDoc(docRef,{ pago:true, quemPagou:usuarioAtual, dataPago:quando });

      // NOVO: dispara a notificação (opcional; se a Cloud Function também tem gatilho no Firestore, isso aqui é redundante)
      if(NOTIFY_URL && NOTIFY_URL.startsWith("http")){
        try{
          await fetch(NOTIFY_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
              nome: d.nome,
              valor: d.valor,
              funcionario: d.funcionario,
              pagoPor: usuarioAtual,
              dataPago: quando
            })
          });
        }catch(e){
          console.warn("Falha ao notificar ADM:", e);
        }
      }
    };

    window.excluir = async function(index){
      const d = (window._exibicaoAtual||[])[index];
      if(!d) return;
      if(usuarioAtual!==d.funcionario && usuarioAtual!=="Vagner"){ alert("Só quem anotou ou Vagner pode excluir."); return; }
      const docRef = doc(db,"dividas", d.id);
      if(usuarioAtual==="Vagner"){
        await updateDoc(docRef,{ removida:true, apagadaPorVagner:true, dataApagada:new Date().toISOString(), motivoExclusao:"Excluído pelo ADM Vagner" });
      }else{
        const motivo = prompt("Informe o motivo da exclusão (até 100 caracteres):");
        if(!motivo){ alert("Motivo é obrigatório."); return; }
        if(motivo.length>100){ alert("Motivo deve ter até 100 caracteres."); return; }
        await updateDoc(docRef,{ removida:true, apagadaPorVagner:false, dataApagada:new Date().toISOString(), motivoExclusao:motivo });
      }
    };
  </script>
</body>
</html>
