<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Dívidas com Firebase</title>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #eef2f5;
      margin: 0;
      padding: 20px 0 80px 0;
    }
    h2 { text-align: center; color: #333; }
    .container {
      max-width: 700px; margin: auto; background: #fff; padding: 20px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .form-group {
      display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
    }
    input, select, button {
      flex: 1 1 150px; padding: 10px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    button { background: #007bff; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }

    .card-cliente {
      background: #f8f9fa; border-left: 5px solid #007bff; border-radius: 8px;
      margin-bottom: 15px; padding: 12px;
    }
    .linha-topo {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .nome { font-size: 18px; font-weight: 700; }
    .totais { font-size: 14px; color:#333; }
    .acoes { display:flex; gap:8px; flex-wrap:wrap; }
    .btn-sec { background:#000; color:#fff; border:none; padding:8px 12px; border-radius:5px; }
    .btn-ok { background:#28a745; color:#fff; border:none; padding:8px 12px; border-radius:5px; }
    .btn-warn { background:#dc3545; color:#fff; border:none; padding:8px 12px; border-radius:5px; }
    .detalhes {
      margin-top:10px; background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:8px;
      display:none;
    }
    .item {
      border-bottom:1px dashed #e0e0e0; padding:8px 0; display:flex; flex-direction:column; gap:6px;
    }
    .item:last-child { border-bottom:none; }
    .lin { font-size:14px; color:#555; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip {
      font-size:12px; border-radius:14px; padding:4px 10px; background:#eef2f7; color:#333; border:1px solid #d6dbe3;
    }
    .chip.pago { background:#e7f6ec; border-color:#b9e4c7; }
    .chip.devendo { background:#fff2e2; border-color:#ffd8a8; }

    #login-section { transition: opacity 0.5s ease; }
    #logado-msg {
      font-size: 20px; color: #007bff; font-weight: bold; text-align: center;
      margin-bottom: 15px; display: none; justify-content: center; align-items: center; gap: 15px;
    }
    #btn-sair {
      background: #dc3545; border: none; color: #fff; font-weight: bold;
      padding: 6px 14px; border-radius: 5px; cursor: pointer; font-size: 14px;
    }
    #btn-sair:hover { background: #b02a37; }

    .info-regras {
      background:#f0f8ff; padding:10px; margin-bottom:15px; border:1px solid #007bff;
      border-radius:6px; font-size:14px; color:#004085;
    }

    @media (max-width: 480px) {
      .form-group { flex-direction: column; }
      input, select, button { flex: 1 1 100%; }
      #logado-msg { flex-direction: column; font-size: 18px; gap: 8px; display:none; }
    }

    .whatsapp-btn {
      position: fixed; bottom: 15px; right: 15px; background-color: #25d366; color: white;
      border-radius: 50%; width: 56px; height: 56px; text-align: center; font-size: 30px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer; transition: background-color 0.3s ease;
    }
    .whatsapp-btn:hover { background-color: #128c4a; }
    .whatsapp-btn i { line-height: 56px; }
  </style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="container">
    <h2>Sistema de Controle de Dívidas</h2>

    <div id="login-section">
      <div class="form-group">
        <select id="funcionario">
          <option value="">-- Selecione Funcionário --</option>
          <option value="Karol">Karol</option>
          <option value="Rodrigo">Rodrigo</option>
          <option value="Gabriela">Gabriela</option>
          <option value="Vagner">Vagner (ADM)</option>
        </select>
        <input type="password" id="senha" placeholder="Senha" />
        <button onclick="acessarSistema()">Entrar</button>
      </div>

      <div class="form-group" style="margin-top:-10px;">
        <label><input type="checkbox" id="lembrarSenha" /> Salvar senha neste terminal</label>
      </div>
    </div>

    <div id="logado-msg">
      <span></span>
      <button id="btn-sair" onclick="sair()">Sair</button>
    </div>

    <div id="formulario" style="display:none;">
      <div class="form-group">
        <input type="text" id="nomeCliente" placeholder="Nome do cliente" autocomplete="off" />
        <input type="number" id="valor" placeholder="Valor da dívida (R$)" step="0.01" min="0.01" />
        <button onclick="adicionarDivida()">Adicionar Dívida</button>
      </div>
    </div>

    <div class="info-regras">
      • Para **adicionar mais valor** a um cliente já existente, use o botão <b>“Adicionar valor”</b> dentro do cartão do cliente.<br>
      • Lançamentos **pagos somem após 15 dias** automaticamente do sistema.<br>
      • **Devendo fica em cima**, e clientes só com lançamentos pagos **descem**.
    </div>

    <div id="lista" style="margin-top:20px;"></div>
  </div>

  <a href="https://wa.me/5583996323995" target="_blank" rel="noopener noreferrer" class="whatsapp-btn" aria-label="WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
      query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    // ---- FIREBASE ----
    const firebaseConfig = {
      apiKey: "AIzaSyCfHDdYAW8DkZ-XELvUWhUo3ln5rAu-1h8",
      authDomain: "adrjb-99601.firebaseapp.com",
      projectId: "adrjb-99601",
      storageBucket: "adrjb-99601.firebasestorage.app",
      messagingSenderId: "688129341856",
      appId: "1:688129341856:web:c0a378171329e52c038cc5",
      measurementId: "G-2BXZJ9LETC",
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- LOGIN ----
    const senhas = { Karol: "14", Rodrigo: "@4", Gabriela: "66", Vagner: "admin" };
    let usuarioAtual = "";
    let lancamentos = []; // documentos brutos da coleção "dividas"

    const loginSection = document.getElementById("login-section");
    const logadoMsg = document.getElementById("logado-msg");
    const formulario = document.getElementById("formulario");
    const lista = document.getElementById("lista");
    const funcionarioSelect = document.getElementById("funcionario");
    const senhaInput = document.getElementById("senha");
    const lembrarSenhaCheckbox = document.getElementById("lembrarSenha");
    const nomeClienteInput = document.getElementById("nomeCliente");
    const valorInput = document.getElementById("valor");

    funcionarioSelect.addEventListener("change", () => {
      const sel = funcionarioSelect.value;
      senhaInput.value = localStorage.getItem(`senha_${sel}`) || "";
    });

    function mostrarLogin(m) { loginSection.style.display = m ? "block" : "none"; }
    function mostrarLogadoMsg(m) {
      if (m) { logadoMsg.querySelector("span").textContent = `Logado como ${usuarioAtual}`; }
      logadoMsg.style.display = m ? "flex" : "none";
    }
    function mostrarFormulario(m) { formulario.style.display = m ? "block" : "none"; }
    function mostrarLista(m) { lista.style.display = m ? "block" : "none"; }

    window.acessarSistema = function () {
      const funcionario = funcionarioSelect.value;
      const senha = senhaInput.value;
      if (!funcionario || senha !== senhas[funcionario]) { alert("Senha incorreta!"); return; }
      usuarioAtual = funcionario;

      if (lembrarSenhaCheckbox.checked) {
        localStorage.setItem(`senha_${usuarioAtual}`, senhaInput.value);
      } else {
        localStorage.removeItem(`senha_${usuarioAtual}`);
      }
      mostrarLogin(false); mostrarLogadoMsg(true); mostrarFormulario(true); mostrarLista(true);
      iniciarListenerRealtime();
    };

    window.sair = function () {
      usuarioAtual = "";
      mostrarLogin(true); mostrarLogadoMsg(false); mostrarFormulario(false); mostrarLista(false);
      senhaInput.value = ""; funcionarioSelect.value = ""; lista.innerHTML = "";
      nomeClienteInput.value = ""; valorInput.value = "";
    };

    // ---- REALTIME ----
    async function iniciarListenerRealtime() {
      const q = query(collection(db, "dividas"), orderBy("dataDevendo", "desc"));
      onSnapshot(q, (qsnap) => {
        lancamentos = [];
        qsnap.forEach(docSnap => {
          const d = docSnap.data();
          lancamentos.push({
            id: docSnap.id,
            nome: d.nome,
            valor: Number(d.valor || 0),
            funcionario: d.funcionario || "",
            dataDevendo: d.dataDevendo || "",
            pago: !!d.pago,
            quemPagou: d.quemPagou || "",
            dataPago: d.dataPago || "",
            removida: !!d.removida,
            apagadaPorVagner: !!d.apagadaPorVagner,
            dataApagada: d.dataApagada || "",
            motivoExclusao: d.motivoExclusao || ""
          });
        });
        atualizarListaAgrupada();
      });
    }

    // ---- ADICIONAR DÍVIDA (NOVO LANÇAMENTO) ----
    window.adicionarDivida = async function () {
      const nome = nomeClienteInput.value.trim();
      const valor = parseFloat(valorInput.value);
      if (!nome || isNaN(valor) || valor <= 0) { alert("Preencha nome e valor corretamente!"); return; }
      // limite de ativos (não removidos) — mantém sua regra antiga
      const ativos = lancamentos.filter(l => !l.removida).length;
      if (ativos >= 100) { alert("Limite de 100 clientes/lançamentos ativos atingido."); return; }

      await addDoc(collection(db, "dividas"), {
        nome,
        valor,
        funcionario: usuarioAtual,
        dataDevendo: new Date().toISOString(),
        pago: false,
        quemPagou: "",
        dataPago: "",
        removida: false,
        apagadaPorVagner: false,
        dataApagada: "",
        motivoExclusao: "",
      });
      nomeClienteInput.value = ""; valorInput.value = "";
    };

    // ---- ADICIONAR VALOR DENTRO DO CARTÃO DO CLIENTE ----
    window.adicionarValorCliente = async function (nome) {
      const txt = prompt(`Adicionar valor para ${nome}:`, "0,00");
      if (!txt) return;
      const valor = parseFloat((txt || "").replace(",", "."));
      if (isNaN(valor) || valor <= 0) { alert("Valor inválido."); return; }
      await addDoc(collection(db, "dividas"), {
        nome,
        valor,
        funcionario: usuarioAtual,
        dataDevendo: new Date().toISOString(),
        pago: false,
        quemPagou: "",
        dataPago: "",
        removida: false,
        apagadaPorVagner: false,
        dataApagada: "",
        motivoExclusao: "",
      });
      // ao inserir um novo lançamento, o "nome sobe" pelo critério de última atividade (ordenamos já)
    };

    // ---- MARCAR PAGO / EXCLUIR (POR LANÇAMENTO) ----
    window.marcarPago = async function (id) {
      const ref = doc(db, "dividas", id);
      await updateDoc(ref, { pago: true, quemPagou: usuarioAtual, dataPago: new Date().toISOString() });
    };

    window.excluirLancamento = async function (id, funcionarioDoLancamento) {
      if (usuarioAtual !== funcionarioDoLancamento && usuarioAtual !== "Vagner") {
        alert("Só quem anotou ou Vagner pode excluir.");
        return;
      }
      const ref = doc(db, "dividas", id);
      if (usuarioAtual === "Vagner") {
        await updateDoc(ref, {
          removida: true, apagadaPorVagner: true, dataApagada: new Date().toISOString(),
          motivoExclusao: "Excluído pelo ADM Vagner",
        });
      } else {
        const motivo = prompt("Informe o motivo da exclusão (até 100 caracteres):");
        if (!motivo) { alert("Motivo é obrigatório."); return; }
        if (motivo.length > 100) { alert("Motivo deve ter até 100 caracteres."); return; }
        await updateDoc(ref, {
          removida: true, apagadaPorVagner: false, dataApagada: new Date().toISOString(),
          motivoExclusao: motivo,
        });
      }
    };

    // ---- AUTO-LIMPEZA: PAGOS SOMEM APÓS 15 DIAS ----
    async function limparPagosVencidos(docs) {
      const agora = new Date();
      for (const l of docs) {
        if (l.pago && !l.removida && l.dataPago) {
          const dias = (agora - new Date(l.dataPago)) / (1000 * 60 * 60 * 24);
          if (dias >= 15) {
            try { await deleteDoc(doc(db, "dividas", l.id)); } catch(e) { /* ignora erro */ }
          }
        }
      }
    }

    // ---- AGRUPAMENTO POR CLIENTE + ORDENAR ----
    function atualizarListaAgrupada() {
      // 1) remove definitivamente itens marcados como removidos há 72h (mantendo sua regra antiga)
      const agora = new Date();
      const ainda = lancamentos.filter(l => {
        if (l.removida && l.dataApagada) {
          const horas = (agora - new Date(l.dataApagada)) / (1000 * 60 * 60);
          if (horas >= 72) {
            // tentativa de deleção silenciosa
            deleteDoc(doc(db, "dividas", l.id)).catch(()=>{});
            return false;
          }
        }
        return true;
      });

      // 2) auto-apagar pagos com +15 dias
      limparPagosVencidos(ainda);

      // 3) agrupar por nome
      const grupos = new Map();
      for (const l of ainda) {
        if (l.removida) continue; // não mostrar removidos
        if (!grupos.has(l.nome)) grupos.set(l.nome, []);
        grupos.get(l.nome).push(l);
      }

      // 4) montar array de cartões com totais
      const cards = [];
      grupos.forEach((arr, nome) => {
        let totalDevendo = 0, totalPago = 0, temDevendo = false;
        let ultimaAtividade = 0;
        arr.forEach(l => {
          if (l.pago) totalPago += l.valor; else { totalDevendo += l.valor; temDevendo = true; }
          const t1 = l.dataPago ? Date.parse(l.dataPago) : 0;
          const t0 = l.dataDevendo ? Date.parse(l.dataDevendo) : 0;
          ultimaAtividade = Math.max(ultimaAtividade, t1, t0);
        });
        cards.push({
          nome, totalDevendo, totalPago, temDevendo,
          ultimaAtividade, itens: arr.sort((a,b)=>Date.parse(b.dataDevendo||0)-Date.parse(a.dataDevendo||0))
        });
      });

      // 5) ordenar: quem tem devendo primeiro; dentro, por última atividade desc
      cards.sort((a,b) => {
        if (a.temDevendo !== b.temDevendo) return a.temDevendo ? -1 : 1; // devendo em cima
        return b.ultimaAtividade - a.ultimaAtividade; // mais recente em cima
      });

      // 6) render
      lista.innerHTML = "";
      for (const c of cards) {
        const card = document.createElement("div");
        card.className = "card-cliente";
        card.innerHTML = `
          <div class="linha-topo">
            <div>
              <div class="nome">${c.nome}</div>
              <div class="totais">
                <b>Devendo:</b> R$ ${c.totalDevendo.toFixed(2)} &nbsp;•&nbsp;
                <b>Pago (histórico):</b> R$ ${c.totalPago.toFixed(2)}
              </div>
            </div>
            <div class="acoes">
              <button class="btn-sec" onclick="adicionarValorCliente('${escapeAspas(c.nome)}')">Adicionar valor</button>
              <button class="btn-sec" onclick="toggleDetalhes(this)">Detalhes</button>
            </div>
          </div>
          <div class="detalhes"></div>
        `;
        const detalhes = card.querySelector(".detalhes");
        detalhes.appendChild(renderizarItensCliente(c.itens));
        lista.appendChild(card);
      }
    }

    function escapeAspas(s){ return s.replace(/\\/g,"\\\\").replace(/'/g,"\\'"); }

    function toggleDetalhes(btn){
      const det = btn.closest(".card-cliente").querySelector(".detalhes");
      det.style.display = det.style.display === "none" || det.style.display === "" ? "block" : "none";
    }

    function renderizarItensCliente(itens){
      const wrap = document.createElement("div");
      for (const l of itens) {
        const div = document.createElement("div");
        div.className = "item";
        const linhas = [];
        linhas.push(`<div class="lin"><b>Valor:</b> R$ ${l.valor.toFixed(2)}</div>`);
        linhas.push(`<div class="lin"><b>Anotado por:</b> ${l.funcionario} &nbsp;•&nbsp; <b>Em:</b> ${formatarData(l.dataDevendo)}</div>`);
        if (l.pago) {
          linhas.push(`<div class="lin"><b>Pago por:</b> ${l.quemPagou} &nbsp;•&nbsp; <b>Em:</b> ${formatarData(l.dataPago)}</div>`);
        }
        if (l.removida) {
          linhas.push(`<div class="lin">Apagada em ${formatarData(l.dataApagada)} &nbsp;•&nbsp; Motivo: ${l.motivoExclusao || "—"}</div>`);
        }
        const chips = [];
        chips.push(`<span class="chip ${l.pago ? 'pago' : 'devendo'}">${l.pago ? 'Pago' : 'Devendo'}</span>`);
        if (usuarioAtual === l.funcionario || usuarioAtual === "Vagner") {
          chips.push(`<button class="btn-warn" onclick="excluirLancamento('${l.id}','${escapeAspas(l.funcionario)}')">Excluir</button>`);
        }
        if (!l.pago) {
          chips.push(`<button class="btn-ok" onclick="marcarPago('${l.id}')">Marcar pago</button>`);
        }
        div.innerHTML = `
          ${linhas.join("")}
          <div class="chips">${chips.join("")}</div>
        `;
        wrap.appendChild(div);
      }
      return wrap;
    }

    function formatarData(iso){
      if (!iso) return "—";
      try { return new Date(iso).toLocaleString(); } catch(e){ return "—"; }
    }
  </script>
</body>
</html>
